name: End to End Test

on:
  push:

jobs:
  create-cluster:
    runs-on: ubuntu-latest
    steps:
    # git checkout code
    - name: Checkout
      uses: actions/checkout@v2
    - name: Create k8s Kind Cluster
      uses: helm/kind-action@v1.5.0
      with:
        config: hack/kind.yaml
        cluster_name: k8s
    - name: Test kind
      run: |
        kubectl get ns
    - name: Create test pod
      run: |
        kubectl run nginx --image=nginx
        sleep 30
        kubectl get pods
        sleep 1m
    - name: Test podinfo api with curl
      run: |
        response=$(curl -X GET "http://localhost:9099/podinfotable?searchkey=name&searchvalue=nginx")
        if echo "$response" | grep -q "nginx"; then
          echo "URL test passed"
        else
          echo "URL test failed"
          exit 1
        fi